<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lista de la compra</title>
<style>
:root{
  --bg: #d0e4f7; --card: #ffffff; --category: #1e3a8a; --button-bg: #3b82f6; --button-text: #ffffff;
  --summary-text: #111827; --glass: rgba(0,0,0,0.03); --muted: #374151; --success:#10b981;
}
*{box-sizing:border-box}
body{
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  margin:0; background: linear-gradient(180deg,#a0c4f7 0%, #d0e4f7 100%); color: #111827; padding:28px;
}
.container{max-width:1100px;margin:0 auto}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
h1{font-size:1.8rem; margin:0; color:var(--category); font-weight:700;}
p.lead{margin:4px 0 0;color:var(--muted)}
.board{display:grid;grid-template-columns: 1fr 340px;gap:20px}
.card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.category{margin-bottom:14px; position: relative;}
.category h3{margin:0 0 10px;font-size:1rem;color:var(--category);font-weight:600; display:inline-block;}
.cat-delete-btn{background:transparent;color:red;font-weight:700;border:none;cursor:pointer;font-size:1rem;margin-left:10px;}
.row{display:grid;grid-template-columns: 36px 1fr 90px 90px 90px 30px;gap:10px;align-items:center;padding:8px;border-radius:8px;background:var(--glass);margin-bottom:8px;transition:0.2s}
.row:hover{background:rgba(59,130,246,0.1)}
.row .name{font-weight:600;color:#111827;}
.row .small{font-size:.85rem;color:var(--muted)}
input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:transparent;color:inherit}
input[type=checkbox]{width:20px;height:20px;accent:var(--button-bg)}
select{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.2);background:transparent;color:inherit}
.delete-btn{background:transparent;color:red;font-weight:700;border:none;cursor:pointer;font-size:1rem;}
.summary{position:sticky;top:28px}
.summary .big{font-size:1.4rem;font-weight:700;color:var(--summary-text);}
.summary .muted{color:var(--summary-text);font-weight:700;font-size:.95rem;}
.total-line{display:flex;justify-content:space-between;align-items:center;padding:14px;background:rgba(59,130,246,0.05);border-radius:10px;margin-top:12px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
button{padding:10px 12px;border-radius:10px;border:0;background:var(--button-bg);color:var(--button-text);font-weight:600;cursor:pointer;transition:0.2s;}
button:hover{background:#2563eb;}
button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.2);color:var(--button-bg);}
footer{margin-top:18px;color:var(--muted);font-size:.9rem}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:1000;}
.modal{background:#fff;padding:20px;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.3);}
.modal button{margin-top:10px;margin-right:5px;}
@media (max-width:880px){.board{grid-template-columns:1fr} .summary{position:relative;top:auto}}
</style>
</head>
<body>
<div class="container">
<header>
  <div>
    <h1>Lista de la compra</h1>
    <p class="lead"> </p>
  </div>
  <br>
  <div class="muted">¤apxx_02¤</div>
</header>

<main class="board">
  <section class="card" id="product-list"></section>

  <aside class="summary card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="muted">Resumen</div>
        <div class="big">Total a pagar</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Artículos marcados</div>
        <div id="count" class="big">0</div>
      </div>
    </div>

    <div class="total-line">
      <div>Total</div>
      <div id="total" style="font-weight:800;">0.00 €</div>
    </div>

    <div class="controls">
      <button id="calc">Calcular ahora</button>
      <button id="clear" class="ghost">Desmarcar todo</button>
      <button id="selectAll" class="ghost">Marcar todo</button>
      <button id="calcAll" class="ghost">Calcular todo (sin marcar)</button>
      <button id="export" class="ghost">Exportar CSV</button>
      <button id="resetData" class="ghost">Borrar todos los datos guardados</button>
      <button id="addProduct" class="ghost">Añadir producto</button>
    </div>

    <footer>🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙🐙</footer>
  </aside>
</main>
</div>

<script>
let categories = JSON.parse(localStorage.getItem('listaCompraCategories')) || {
  'Lácteos 🥛': ['Yogures','Leche','Queso','Flan (sobre)'],
  'Embutidos 🥩': ['Salchichón','Chorizo'],
  'Salsas & Complementos 🍯': ['Ketchup','Mostaza','Mayonesa'],
  'Conservas, Pasta & Arroz 🍝': ['Tomate','Atún','Arroz','Macarrones'],
  'Pan, Huevos & Repostería 🥚🍞': ['Pan (molde)','Huevos','Galletas','Chocolate'],
  'Bebidas 🍷🥤': ['Vino','Zumos'],
  'Limpieza & Higiene 🧴🧼': ['Suavizante','Detergente','Gel','Champú'],
  'Verduras, Fruta & Otros 🥦🍎': ['Verduras','Fruta','Otros']
};
function saveCategories(){ localStorage.setItem('listaCompraCategories', JSON.stringify(categories)); }

const list = document.getElementById('product-list');
function loadData(){ return JSON.parse(localStorage.getItem('listaCompraData')||'{}'); }
function saveData(){
  const data={};
  document.querySelectorAll('.row').forEach(r=>{
    const item=r.dataset.item;
    data[item]={ checked:r.querySelector('.chk').checked, qty:r.querySelector('.qty').value, price:r.querySelector('.price').value };
  });
  localStorage.setItem('listaCompraData',JSON.stringify(data));
}

function createRow(item, prev){
  const row=document.createElement('div');
  row.className='row';
  row.dataset.item=item;
  row.innerHTML=`
    <div><input type="checkbox" class="chk" ${prev?.checked?'checked':''}></div>
    <div><div class="name">${item}</div></div>
    <div><input type="number" class="qty" min="0" step="1" value="${prev?.qty||1}"></div>
    <div><input type="number" class="price" min="0" step="0.01" value="${prev?.price||1.00}"></div>
    <div class="subtotal">0.00 €</div>
    <div><button class="delete-btn">×</button></div>
  `;
  row.querySelector('.delete-btn').addEventListener('click',()=>{
    for(let cat in categories){
      const idx = categories[cat].indexOf(item);
      if(idx>-1){ categories[cat].splice(idx,1); saveCategories(); break; }
    }
    renderList(); calculateAll();
  });
  return row;
}

function renderList(){
  const saved=loadData();
  list.innerHTML='';
  for(let [cat, items] of Object.entries(categories)){
    const section=document.createElement('div'); section.className='category';
    section.innerHTML=`<h3>${cat}</h3><button class="cat-delete-btn">🗑️</button>`;
    section.querySelector('.cat-delete-btn').addEventListener('click',()=>{
      if(confirm(`¿Eliminar la categoría "${cat}" y todos sus productos?`)){
        delete categories[cat];
        saveCategories();
        renderList();
        calculateAll();
      }
    });
    items.forEach(item=>{ section.appendChild(createRow(item,saved[item])); });
    list.appendChild(section);
  }
}

renderList();

function format(n){ return n.toFixed(2)+' €'; }

function calculateAll(includeUnchecked=false){
  const rows=document.querySelectorAll('.row'); let total=0, count=0;
  rows.forEach(r=>{
    const chk=r.querySelector('.chk');
    const qty=parseFloat(r.querySelector('.qty').value)||0;
    const price=parseFloat(r.querySelector('.price').value)||0;
    const subtotalEl=r.querySelector('.subtotal');
    const selected=chk.checked||includeUnchecked;
    const subtotal=selected?qty*price:0;
    subtotalEl.textContent=format(subtotal);
    total+=subtotal;
    if(chk.checked) count++;
  });
  document.getElementById('total').textContent=format(total);
  document.getElementById('count').textContent=count;
  saveData();
}

// Botones
document.getElementById('calc').addEventListener('click',()=>calculateAll());
document.getElementById('calcAll').addEventListener('click',()=>calculateAll(true));
document.getElementById('clear').addEventListener('click',()=>{document.querySelectorAll('.chk').forEach(c=>c.checked=false); calculateAll();});
document.getElementById('selectAll').addEventListener('click',()=>{document.querySelectorAll('.chk').forEach(c=>c.checked=true); calculateAll();});
document.getElementById('resetData').addEventListener('click',()=>{
  if(confirm('¿Estás seguro de que quieres borrar todos los datos guardados?')){
    localStorage.removeItem('listaCompraData');
    localStorage.removeItem('listaCompraCategories');
    location.reload();
  }
});
document.getElementById('export').addEventListener('click',()=>{
  const rows=document.querySelectorAll('.row');
  const lines=[["Producto","Marcado","Cantidad","Precio","Subtotal"]];
  rows.forEach(r=>{
    const name=r.dataset.item;
    const chk=r.querySelector('.chk').checked?'sí':'no';
    const qty=r.querySelector('.qty').value;
    const price=r.querySelector('.price').value;
    const subtotal=r.querySelector('.subtotal').textContent.replace(' €','');
    lines.push([name,chk,qty,price,subtotal]);
  });
  const csv=lines.map(l=>l.join(',')).join('\n');
  const fn='lista_compra_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.csv';
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download=fn; a.click();
});

// Añadir producto con modal
document.getElementById('addProduct').addEventListener('click', () => {
  const name = prompt('Nombre del producto:');
  if (!name) return;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `<p>Elige la categoría para "${name}"</p>`;
  
  const select = document.createElement('select');
  Object.keys(categories).forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = cat; select.appendChild(opt);
  });
  const newOpt = document.createElement('option');
  newOpt.value = '__new__'; newOpt.textContent = 'Nueva categoría...'; select.appendChild(newOpt);
  modal.appendChild(select);

  const btnAdd = document.createElement('button'); btnAdd.textContent = 'Agregar';
  const btnCancel = document.createElement('button'); btnCancel.textContent = 'Cancelar';
  modal.appendChild(btnAdd); modal.appendChild(btnCancel);
  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  btnCancel.addEventListener('click',()=>overlay.remove());
  btnAdd.addEventListener('click',()=>{
    let cat = select.value;
    if(cat==='__new__'){
      const newName = prompt('Nombre de la nueva categoría:');
      if(!newName) return;
      cat = newName;
    }
    if(!categories[cat]) categories[cat]=[];
    categories[cat].push(name); saveCategories();
    renderList(); calculateAll(); overlay.remove();
  });
});

document.addEventListener('input', e=>{if(e.target.matches('.qty, .price, .chk')) calculateAll();});
calculateAll();
</script>
</body>
</html>
